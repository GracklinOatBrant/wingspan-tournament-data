<html>
<head>
    <meta charset="utf-8">
    <title>Wingspan Tournament Data Visualization</title>
    <link rel="stylesheet" href="assets/chosen.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê¶</text></svg>">

    <script src="assets/jquery.min.js"></script>
    <script src="assets/chosen.jquery.js"></script>
    <script src="assets/plotly.min.js"></script>
    <style type="text/css">
        label {
            display: inline-block;
        }
        body {
            width: 80%;
            margin: 0 auto;
        }
        
        header {
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        fieldset {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        footer {
            position: fixed;
            bottom: 0;
            padding: 1.5rem;
            left: 0;
            right: 0;
            text-align: center;
            background: rgb(250, 250, 250);
        }
    </style>
</head>
<body>
    <header>
        <h1 class="title">ü¶Ö Wingspan Tournament Data Visualization ü¶¢</h1>
    </header>

    <fieldset id="filters">
        <label>Tournament:&nbsp;<select data-placeholder="All tournaments" class="tournament-select" multiple></select></label>
        <label>User:&nbsp;<select data-placeholder="All users" class="user-select" multiple></select></label>
        <button class='button is-small clear-filters'>Clear filters</button>
    </fieldset>
    <button class='button is-small is-info' id="add-comparison">
        Add comparison
    </button>

   <div id="scoreHistogram"></div>

   <footer>
    Made by ü¶Ü<a href="https://github.com/GracklinOatBrant/wingspan-tournament-data">GracklinOatBrant</a>üïä &mdash; <a href="https://discord.gg/ryUwcZZYC7">Tournament Discord</a>
   </footer>
</body>

<script>
    $(document).ready(async () => {
        const filterHtml = $("#filters").html();

        const todaysDate = new Date().toJSON().slice(0, 10);
        const response = await fetch(`wingspan_tournaments.json?${todaysDate}`);
        const tourneys = await response.json();
        
        // add month name & year to tourneys from date
        for (const tourney of tourneys) {
            const date = new Date(tourney.date);
            tourney.year = date.getFullYear();
            tourney.month = date.toLocaleString('default', { month: 'long' });
        }

        const userSet = new Set();
        for (const tourney of tourneys) {
            for (const scores of tourney.scores) {
                for (const user of Object.keys(scores)) {
                    userSet.add(user);
                }
            }
        }
        // alphabetize and convert to list
        const users = Array.from(userSet).sort();

        // aggregate tourney info
        const tourneyName = (tourney) => `${tourney.name} (${tourney.month} ${tourney.year})`;
        const tourneyNames = tourneys.map(tourneyName);

        // create a helper class to initialize a fieldset that can contain nested selects
        class FilterFieldset {
            constructor(parentDiv) {
                this.parentDiv = parentDiv;

                this.userSelect = parentDiv.find(".user-select");
                this.tourneySelect = parentDiv.find(".tournament-select");
                this.clearButton = parentDiv.find(".clear-filters");
                this.removeButton = parentDiv.find(".remove-comparison");

                for (const user of users) {
                    this.userSelect.append(`<option value="${user}">${user}</option>`);
                }

                for (const tourney of tourneyNames) {
                    this.tourneySelect.append(`<option value="${tourney}">${tourney}</option>`);
                }

                parentDiv.find('select[multiple]').chosen({
                  case_sensitive_search: false
                });

                this.clearButton.on("click", (ev) => {
                    this.clear();
                    return false;
                });

                if (this.removeButton) {
                    this.removeButton.on("click", (ev) => {
                        this.parentDiv.remove();
                        fieldsets = fieldsets.filter((fieldset) => fieldset !== this);
                        redrawHistogram();
                        return false;
                    });
                }
            }

            getScores() {
                const allScores = [];

                for (const tourney of tourneys) {
                    if (this.tourneySelect.val().length && !this.tourneySelect.val().includes(tourneyName(tourney))) {
                        continue;
                    }
                    
                    for (const scores of tourney.scores) {
                        const users = Object.keys(scores);

                        for (let playerIdx = 0; playerIdx < users.length; playerIdx++) {
                            const user = users[playerIdx];
                            if (this.userSelect.val().length && !this.userSelect.val().includes(user)) {
                                continue;
                            }
                            if (scores[user] == 0) {
                                continue;
                            }
                            allScores.push(scores[user]);
                        }

                    }
                }

                return allScores;
            }

            clear() {
                this.userSelect.val('').trigger('chosen:updated');
                this.tourneySelect.val('').trigger('chosen:updated');
                if (this.clearCallback) {
                    this.clearCallback();
                }
            }

            on(event, callback) {
                this.userSelect.on(event, callback);
                this.tourneySelect.on(event, callback);
                this.clearCallback = callback;
            }

            getLabel() {
                const labelParts = [];
                if (this.tourneySelect.val().length) {
                    labelParts.push(`Tourney: ${this.tourneySelect.val().join(", ")}`);
                }
                if (this.userSelect.val().length) {
                    labelParts.push(`User: ${this.userSelect.val().join(", ")}`);
                }
                if (labelParts.length) {
                    return labelParts.join(", ");
                } else {
                    return "All data";
                }
            }
        }

        let fieldsets = [new FilterFieldset($("#filters"))];

        const redrawHistogram = () => {
            const traces = []
            for (const fieldset of fieldsets) {
                const scores = fieldset.getScores();
                const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
                const label = `${fieldset.getLabel()} (Average Score = ${mean.toFixed(2)})`;
                const trace = {
                    x: scores,
                    type: 'histogram',
                    histnorm: 'probability',
                    opacity: 0.75,
                    name: label, 
                    autobinx: false,
                    xbins: {
                        start: 45,
                        end: 160, 
                        size: 5, 
                    }
                };
                traces.push(trace);
            }
            // Use plotly to draw a histogram of tournament scores
            Plotly.newPlot('scoreHistogram', traces, {
                showlegend: true,
                barmode: "overlay", 
                yaxis: {title: 'Fraction of all scores'},
                legend: {"orientation": "h"},
                title: {
                    text: 'Wingspan Tournament Scores'
                }
            });
        };   

        for (const fieldset of fieldsets) {
            fieldset.on("change", redrawHistogram);
        }

        $('#add-comparison').on("click", (ev) => {
            const newFieldsetEl = $("<fieldset></fieldset>");
            newFieldsetEl.html(filterHtml);
            newFieldsetEl.append("<button class='button is-small is-warning remove-comparison'>Remove comparison</button>");
            $("#filters").after(newFieldsetEl);
            const newFieldset = new FilterFieldset(newFieldsetEl);
            newFieldset.on("change", redrawHistogram);
            fieldsets.push(newFieldset);
            redrawHistogram();
            return false;
        });

        redrawHistogram();
    });
</script>
</html>
